<!DOCTYPE html>
<html>
<head>
    <title>CV Transcription Search</title>
    <style>
        body { font-family: Arial, sans-serif; margin: 20px; }
        .search-container { margin-bottom: 20px; }
        .filters { display: flex; gap: 10px; margin: 10px 0; }
        .filter-select { padding: 5px; }
        .results { margin-top: 20px; }
        .result-item { 
            border: 1px solid #ddd; 
            padding: 15px; 
            margin: 10px 0; 
            border-radius: 5px; 
        }
        .result-title { font-weight: bold; color: #2196F3; }
        .result-meta { color: #666; font-size: 0.9em; }
        .loading { display: none; }
        input[type="text"] { 
            padding: 8px; 
            width: 300px; 
            border: 1px solid #ddd; 
            border-radius: 4px; 
        }
        button { 
            padding: 8px 15px; 
            background: #2196F3; 
            color: white; 
            border: none; 
            border-radius: 4px; 
            cursor: pointer; 
        }
    </style>
</head>
<body>
    <h1>CV Transcription Search</h1>
    
    <div class="search-container">
        <input type="text" id="searchQuery" placeholder="Search transcriptions..." />
        <button onclick="performSearch()">Search</button>
        
        <div class="filters">
            <select id="ageFilter" class="filter-select" onchange="performSearch()">
                <option value="">All Ages</option>
            </select>
            <select id="genderFilter" class="filter-select" onchange="performSearch()">
                <option value="">All Genders</option>
            </select>
            <select id="accentFilter" class="filter-select" onchange="performSearch()">
                <option value="">All Accents</option>
            </select>
        </div>
    </div>
    
    <div class="loading" id="loading">Searching...</div>
    <div id="results" class="results"></div>

    <script>
        let currentAggs = {};

        function performSearch() {
            const query = document.getElementById('searchQuery').value;
            const age = document.getElementById('ageFilter').value;
            const gender = document.getElementById('genderFilter').value;
            const accent = document.getElementById('accentFilter').value;
            
            document.getElementById('loading').style.display = 'block';
            document.getElementById('results').innerHTML = '';
            
            const params = new URLSearchParams();
            if (query) params.append('q', query);
            if (age) params.append('age', age);
            if (gender) params.append('gender', gender);
            if (accent) params.append('accent', accent);
            
            fetch(`/search?${params}`)
                .then(response => response.json())
                .then(data => {
                    document.getElementById('loading').style.display = 'none';
                    
                    if (data.error) {
                        document.getElementById('results').innerHTML = 
                            `<div style="color: red;">Error: ${data.error}</div>`;
                        return;
                    }
                    
                    updateFilters(data.aggregations);
                    displayResults(data.hits, data.total);
                })
                .catch(error => {
                    document.getElementById('loading').style.display = 'none';
                    document.getElementById('results').innerHTML = 
                        `<div style="color: red;">Error: ${error}</div>`;
                });
        }

        function updateFilters(aggs) {
            currentAggs = aggs;
            
            // Update age filter
            const ageSelect = document.getElementById('ageFilter');
            const currentAge = ageSelect.value;
            ageSelect.innerHTML = '<option value="">All Ages</option>';
            if (aggs.ages && aggs.ages.buckets) {
                aggs.ages.buckets.forEach(bucket => {
                    const option = document.createElement('option');
                    option.value = bucket.key;
                    option.textContent = `${bucket.key} (${bucket.doc_count})`;
                    ageSelect.appendChild(option);
                });
            }
            ageSelect.value = currentAge;
            
            // Update gender filter
            const genderSelect = document.getElementById('genderFilter');
            const currentGender = genderSelect.value;
            genderSelect.innerHTML = '<option value="">All Genders</option>';
            if (aggs.genders && aggs.genders.buckets) {
                aggs.genders.buckets.forEach(bucket => {
                    const option = document.createElement('option');
                    option.value = bucket.key;
                    option.textContent = `${bucket.key} (${bucket.doc_count})`;
                    genderSelect.appendChild(option);
                });
            }
            genderSelect.value = currentGender;
            
            // Update accent filter
            const accentSelect = document.getElementById('accentFilter');
            const currentAccent = accentSelect.value;
            accentSelect.innerHTML = '<option value="">All Accents</option>';
            if (aggs.accents && aggs.accents.buckets) {
                aggs.accents.buckets.forEach(bucket => {
                    const option = document.createElement('option');
                    option.value = bucket.key;
                    option.textContent = `${bucket.key} (${bucket.doc_count})`;
                    accentSelect.appendChild(option);
                });
            }
            accentSelect.value = currentAccent;
        }

        function displayResults(hits, total) {
            const resultsDiv = document.getElementById('results');
            
            if (hits.length === 0) {
                resultsDiv.innerHTML = '<div>No results found.</div>';
                return;
            }
            
            let html = `<h3>Found ${total} results</h3>`;
            
            hits.forEach(hit => {
                const source = hit._source;
                html += `
                    <div class="result-item">
                        <div class="result-title">${source.generated_text || 'No title'}</div>
                        <div class="result-meta">
                            Duration: ${source.duration || 'N/A'} | 
                            Age: ${source.age || 'N/A'} | 
                            Gender: ${source.gender || 'N/A'} | 
                            Accent: ${source.accent || 'N/A'}
                            ${source.filename ? ' | File: ' + source.filename : ''}
                        </div>
                        ${source.text ? `<div style="margin-top: 10px;">${source.text}</div>` : ''}
                    </div>
                `;
            });
            
            resultsDiv.innerHTML = html;
        }

        // Search on Enter key
        document.getElementById('searchQuery').addEventListener('keypress', function(e) {
            if (e.key === 'Enter') {
                performSearch();
            }
        });

        // Load initial results
        performSearch();
    </script>
</body>
</html>